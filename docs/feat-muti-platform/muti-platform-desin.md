# Go-Stock 多平台设计方案

## 1. 设计背景

Go-Stock是一个基于Wails和Go开发的股票分析工具，支持A股、港股和美股分析。目前项目已经有针对Windows和macOS的实现，但存在以下问题：

1. 平台特定代码直接嵌入在主要业务逻辑中
2. 大量功能重复实现在不同平台文件中
3. 缺乏统一的跨平台抽象层
4. 平台特定功能实现方式不一致

本设计方案旨在提供一个更清晰、可维护的多平台架构，使应用能够在保持核心功能一致的同时，充分利用各平台特性。

## 2. 整体架构设计

### 2.1 架构图

```
┌─────────────────────────────────────────────────────────┐
│                     前端层 (Frontend)                    │
│                                                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │
│  │  Vue 组件   │ │   状态管理   │ │   通用UI/交互   │   │
│  └─────────────┘ └─────────────┘ └─────────────────┘   │
└───────────────────────────┬─────────────────────────────┘
                            │
                 ┌──────────▼───────────┐
                 │    Wails JS 绑定     │
                 └──────────┬───────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                       核心层 (Core)                      │
│                                                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │
│  │  业务逻辑   │ │   数据模型   │ │   通用工具类    │   │
│  └─────────────┘ └─────────────┘ └─────────────────┘   │
│                                                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │             平台抽象接口 (Platform API)            │  │
│  └───────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                    平台实现层 (Platform)                 │
│                                                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │
│  │ Windows实现 │ │ macOS实现   │ │   Linux实现     │   │
│  └─────────────┘ └─────────────┘ └─────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 2.2 层次说明

1. **前端层 (Frontend)**：
   - 使用Vue.js + NaiveUI实现的用户界面
   - 负责展示数据和用户交互
   - 通过Wails提供的绑定与后端通信

2. **核心层 (Core)**：
   - 包含所有平台共享的业务逻辑
   - 定义核心数据模型和处理流程
   - 提供平台抽象接口，定义不同平台需要实现的功能

3. **平台实现层 (Platform)**：
   - 为各目标平台提供具体实现
   - 处理平台特定功能（如系统托盘、通知、文件系统等）
   - 通过平台抽象接口与核心层交互

## 3. 关键设计策略

### 3.1 平台抽象接口

创建平台抽象接口，定义所有平台需要实现的功能：

```go
// platform/platform.go
package platform

// Platform 定义所有平台需要实现的接口
type Platform interface {
    // 系统功能
    Initialize() error
    Shutdown() error
    
    // 屏幕相关
    GetScreenResolution() (width int, height int, err error)
    
    // 通知相关
    SendNotification(title string, message string, clickCallback func()) error
    
    // 系统托盘相关
    CreateSystemTray(icon []byte, title string) error
    UpdateSystemTrayTooltip(tooltip string) error
    AddSystemTrayMenuItem(label string, callback func()) error
    
    // 浏览器检测
    CheckBrowser() (path string, exists bool)
    
    // 文件系统操作
    EnsureDataDirectory() error
    
    // 应用单实例锁
    HandleSecondInstance(data interface{}) error
}
```

### 3.2 平台实现注册机制

使用工厂模式创建平台实现实例：

```go
// platform/factory.go
package platform

import (
    "runtime"
)

var platformInstance Platform

// GetPlatform 返回当前平台的实现
func GetPlatform() Platform {
    if platformInstance == nil {
        switch runtime.GOOS {
        case "windows":
            platformInstance = newWindowsPlatform()
        case "darwin":
            platformInstance = newDarwinPlatform()
        case "linux":
            platformInstance = newLinuxPlatform()
        default:
            // 提供一个基本实现作为后备
            platformInstance = newBasicPlatform()
        }
    }
    return platformInstance
}
```

### 3.3 条件编译

使用Go的构建标签系统进行条件编译，确保只有目标平台的代码被编译：

```go
//go:build windows
// +build windows

package platform

// Windows平台特定实现
```

## 4. 核心功能点

### 4.1 跨平台基础功能

1. **共享数据模型**：
   - 股票基础信息 (StockBasic)
   - 关注的股票 (FollowedStock)
   - 分组管理 (Group)
   - 设置信息 (Settings)

2. **统一API接口**：
   - 股票数据获取和处理
   - 市场行情分析
   - AI分析和报告生成
   - 用户偏好设置

3. **通用业务逻辑**：
   - 股票数据计算
   - 价格监控规则
   - 图表数据处理
   - 基金净值计算

### 4.2 平台特定功能

1. **Windows平台**：
   - 系统托盘集成（使用systray）
   - Windows通知（使用toast）
   - 注册表操作（检测浏览器安装路径）
   - 窗口管理（最小化到托盘）

2. **macOS平台**：
   - macOS通知中心集成
   - 应用数据目录管理（.go-stock/data）
   - 默认浏览器检测和启动
   - 触控栏支持（可选）

3. **Linux平台**：
   - 桌面通知系统集成
   - 文件系统遵循XDG规范
   - D-Bus集成（可选）
   - 支持主流Linux桌面环境

### 4.3 公共基础设施

1. **日志系统**：
   - 统一的日志接口
   - 按平台调整日志存储位置

2. **数据库访问**：
   - 使用GORM进行数据库操作
   - 平台无关的数据持久化

3. **配置管理**：
   - 平台相关配置存储位置
   - 统一的配置接口

4. **更新机制**：
   - 检查新版本
   - 平台特定的更新安装流程

## 5. 实现路径

### 5.1 重构阶段

1. **抽取平台接口**：
   - 定义核心平台抽象接口
   - 将现有功能映射到接口

2. **重构现有平台实现**：
   - 将平台特定代码迁移到对应实现
   - 使用条件编译隔离

3. **统一核心业务逻辑**：
   - 消除重复的业务逻辑
   - 将业务代码与平台代码分离

### 5.2 扩展阶段

1. **完善Linux支持**：
   - 实现Linux平台接口
   - 测试常见Linux发行版

2. **Web版本探索**：
   - 可能的Web版本支持
   - WebAssembly适配

3. **移动平台准备**：
   - 为未来可能的移动版本适配准备接口

## 6. 预期收益

1. **代码质量提升**：
   - 减少代码重复
   - 更清晰的责任划分
   - 更易于测试

2. **维护性改进**：
   - 平台特定问题更容易隔离
   - 新功能更容易跨平台实现
   - 减少平台相关的bug

3. **扩展性增强**：
   - 更容易支持新平台
   - 更好的模块化
   - 增加新功能更为便捷

4. **用户体验优化**：
   - 保持核心功能一致性
   - 提供平台特有的优化体验
   - 更稳定的应用表现

## 7. 风险与缓解

1. **重构风险**：
   - 可能引入新bug
   - 缓解：渐进式重构，保持高测试覆盖率

2. **性能影响**：
   - 抽象层可能带来轻微性能开销
   - 缓解：关键路径优化，性能基准测试

3. **兼容性问题**：
   - 跨平台API差异性
   - 缓解：充分测试，平台特定降级方案

4. **工期延长**：
   - 重构需要时间和资源
   - 缓解：分阶段实施，优先关键组件 